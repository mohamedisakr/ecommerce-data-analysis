-- connect to postgresql
psql -U postgres

-- create user for database
CREATE USER power WITH PASSWORD '<super secret password>';

CREATE DATABASE online_retail WITH OWNER 'power' ENCODING 'UTF8';

-- create ecommerce table 
CREATE TABLE ecom_raw
(
Id NUMERIC(10,0),
InvoiceNo VARCHAR(50),
StockCode VARCHAR(50),
Description VARCHAR(250),
Quantity NUMERIC(10,0),
UnitPrice NUMERIC(14,2),
CustomerID VARCHAR(50),
Country VARCHAR(200),
Date DATE,
Hour NUMERIC(3,0)
); 


-- create holiday table
CREATE TABLE holiday_raw
(
Date DATE,
Holiday	VARCHAR(50),
WeekDay	VARCHAR(50),
Month CHAR(2),
Day CHAR(2),
Year CHAR(4)
);


-- load ecommerce data from CSV file
COPY ecom_raw FROM 'ecommerce_raw_data.csv' DELIMITER ',' CSV NULL 'NULL' HEADER;



-- load holiday data from CSV file
COPY holiday_raw FROM 'US Holiday Dates (2004-2021).csv' DELIMITER ',' CSV NULL 'NULL' HEADER;

-- get the ecom ALL columns
SELECT *
FROM ecom_raw
LIMIT 5;

-- get the ecom specific columns
SELECT Quantity, UnitPrice, Quantity * UnitPrice AS revenue, Date 
FROM ecom_raw
LIMIT 5;


-- get the holiday ALL columns
SELECT *
FROM holiday_raw
WHERE Year = '2011'
LIMIT 5;

-- get the holiday specific columns
SELECT Date, Holiday, Year 
FROM holiday_raw
WHERE Year = '2011';
--LIMIT 5;


-- join ecom & holiday
SELECT e.Quantity, e.UnitPrice, e.Quantity * UnitPrice AS revenue, h.holiday
FROM ecom_raw e LEFT JOIN holiday_raw h
ON e.date = h.date 
WHERE h.year = '2011';


-- sum by join & group ecom & holiday
SELECT h.holiday, ROUND(SUM(e.Quantity * UnitPrice), 2) AS total_revenue
FROM ecom_raw e LEFT JOIN holiday_raw h ON e.date = h.date 
WHERE h.year = '2011'
GROUP BY h.holiday, h.date
ORDER BY total_revenue DESC;


-- performance for sum by join & group ecom & holiday
explain analyze SELECT h.holiday, ROUND(SUM(e.Quantity * UnitPrice), 2) AS total_revenue
FROM ecom_raw e LEFT JOIN holiday_raw h ON e.date = h.date 
WHERE h.year = '2011'
GROUP BY h.holiday, h.date
ORDER BY total_revenue DESC;


-- performance for selecting date from holiday table
explain analyze 
SELECT holiday, date
FROM holiday_raw
WHERE year = '2011';

-- using regex for selecting date from holiday table ==> worst than = ''
explain analyze 
SELECT holiday, date
FROM holiday_raw
WHERE year ~ '2011';


